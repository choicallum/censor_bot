from .bot import Bot
from .id_bot import IdMixin

from config import CENSOR_GUILDS
from discord.commands import DeleteCommand, IdCommand, MessageCommand, ReplyCommand


class CensorBot(IdMixin, Bot):
    def __init__(self):
        super().__init__()

    @property
    def receive_all_messages(self):
        return 'raw'

    async def handle_message(self, gid, cid, author_info, data):
        text = data['content']
        if gid not in CENSOR_GUILDS or author_info['id'] == self._bot_id:
            return

        censored = censor(text)
        if censored:
            message_out = f'Censored - {author_info["username"]}: {censored}'
            reply_info = data.get('message_reference')
            ret = [DeleteCommand()]
            if reply_info is None:
                ret.append(MessageCommand(cid, message_out))
            else:
                allow_mentions = False
                if 'mentions' in data:
                    allow_mentions = {'user': [user['id'] for user in data['mentions']]}
                ret.append(ReplyCommand(gid, cid, reply_info['message_id'], message_out, allow_mentions=allow_mentions))
            return ret

def censor(message_text):
    msg = message_text
    count = 0
    while 'poggers' in msg.lower():
       poggers_index = msg.lower().index('poggers')
       msg = msg[:poggers_index] + 'p\\*ggers' + msg[poggers_index + 7:]
       count = count + 1;

    while 'objectively' in msg.lower():
       obj_index = msg.lower().index('objectively')
       msg = msg[:obj_index] + 'ob\\*ectively' + msg[obj_index + 11:]
       count = count + 1;

    if count >= 1:
        return msg
    else:
        return None